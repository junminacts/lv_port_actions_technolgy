/*
 * Copyright (c) 2020 Actions Technology Co., Ltd
 *
 * SPDX-License-Identifier: Apache-2.0
 */

#include <sys/byteorder.h>
#include "panel_device.h"

/*********************
 *      DEFINES
 *********************/

/*
#define CONFIG_PANEL_PORT_TYPE            PANEL_PORT_QSPI_SYNC
#define CONFIG_PANEL_PORT_CS              (0)
#define CONFIG_PANEL_PORT_SPI_CPOL        (0)
#define CONFIG_PANEL_PORT_SPI_CPHA        (0)
#define CONFIG_PANEL_PORT_SPI_DUAL_LANE   (1)
#define CONFIG_PANEL_TIMING_HACTIVE	      (272)
#define CONFIG_PANEL_TIMING_VACTIVE	      (480)
#define CONFIG_PANEL_TIMING_PIXEL_CLK_KHZ (50000)
#define CONFIG_PANEL_TIMING_HFRONT_PORCH  (286)
#define CONFIG_PANEL_TIMING_VBACK_PORCH   (44)
#define CONFIG_PANEL_TIMING_VFRONT_PORCH  (45)
#define CONFIG_PANEL_ROUND_SHAPE          (0)
#define CONFIG_PANEL_ESD_CHECK_PERIOD     (0)
*/

#define DDIC_CMD_HS 0x60 /* Horizontal SYNC Command */
#define DDIC_CMD_VS 0x61 /* Vertical SYNC Command */

/**********************
 *      TYPEDEFS
 **********************/

/**********************
 *  STATIC PROTOTYPES
 **********************/

/**********************
 *  STATIC VARIABLES
 **********************/

/**********************
 *      MACROS
 **********************/

#define DDIC_QSPI_CMD_RD(cmd)    ((0x03 << 24) | ((uint32_t)(cmd) << 8))
#define DDIC_QSPI_CMD_WR(cmd)    ((0x02 << 24) | ((uint32_t)(cmd) << 8))
#define DDIC_QSPI_CMD_RAMWR(cmd) ((0x32 << 24) | ((uint32_t)(cmd) << 8))

/**********************
 *  FUNCTIONS
 **********************/
static void _panel_transmit(const struct device *dev, uint32_t cmd,
		const uint8_t *tx_data, size_t tx_count)
{
	struct lcd_panel_data *data = dev->data;

	display_controller_write_config(data->lcdc_dev, DDIC_QSPI_CMD_WR(cmd), tx_data, tx_count);
}

static inline void _panel_transmit_cmd(const struct device *dev, uint32_t cmd)
{
	_panel_transmit(dev, cmd, NULL, 0);
}

static inline void _panel_transmit_p1(const struct device *dev, uint32_t cmd, uint8_t tx_data)
{
	_panel_transmit(dev, cmd, &tx_data, 1);
}

static int _panel_init(const struct device *dev)
{
	const uint8_t data_0[] = {0x00,0x00,0x00,0x00,0x00,0x00,0x5A,0xA5};
	const uint8_t data_1[] = {0x00,0x10,0x00,0x02,0x00,0x00,0x04,0x3F,0x20,0x05,0x3F,0x3F,0x00,0x00,0x00,0x00,0x00};
	const uint8_t data_3[] = {0xE0,0x10,0x51,0x24,0x08,0x05,0x10,0x05,0x60,0x15,0xC2,0x42,0x22,0x22,0xAA,0x03,0x10,0x12,0x60,0x14,0x1E,0x51,0x15,0x00,0xA8,0x20,0x00,0x03,0x0D,0x12};
	const uint8_t data_4[] = {0xA0,0x06,0xAa,0x00,0x08,0x02,0x0A,0x04,0x04,0x04,0x04,0x04,0x04,0x04,0x04,0x04,0x04,0x04,0x04,0x00,0x55,0x55};
	//test mod
	//const uint8_t data_2[] = {0x21,0x0A,0x20,0x14,0xD8,0x70,0xF0,0xE0,0x10,0x19,0x80,0x80,0x80,0x20,0xf9,0x10,0x02,0xff,0xff,0xF0,0x90,0x01,0x32,0xA0,0x81,0xC0,0x20,0x7F,0xFF,0x00,0x54};
#if CONFIG_PANEL_COLOR_DEPTH == 24
	const uint8_t data_2[] = {0x20,0x0A,0x20,0x14,0xD8,0x70,0xF0,0xE0,0x10,0x19,0x80,0x80,0x80,0x20,0xf9,0x10,0x02,0xff,0xff,0xF0,0x90,0x01,0x32,0xA0,0x81,0xC0,0x00,0x7F,0xFF,0x00,0x54};
	const uint8_t data_5[] = {0x13,0x04,0x02,0x02,0x71,0x05,0x24,0x55,0x02,0x00,0x41,0x00,0x53,0xFF,0xFF,0xFF,0x4F,0x52,0x00,0x4F,0x52,0x00,0x45,0x3B,0x0B,0x02,0x0d,0x00,0xFF,0x40};
#else /* CONFIG_PANEL_COLOR_DEPTH == 16 */
	const uint8_t data_2[] = {0x20,0x0A,0x20,0x14,0xD8,0x70,0xF0,0xE0,0x10,0x19,0x80,0x80,0x80,0x20,0xf9,0x10,0x02,0xff,0xff,0xF0,0x90,0x01,0x32,0xA0,0x81,0xC0,0x20,0x7F,0xFF,0x00,0x54};
	const uint8_t data_5[] = {0x33,0x04,0x02,0x02,0x71,0x05,0x24,0x55,0x02,0x00,0x41,0x00,0x53,0xFF,0xFF,0xFF,0x4F,0x52,0x00,0x4F,0x52,0x00,0x45,0x3B,0x0B,0x02,0x0d,0x00,0xFF,0x40};
#endif
	const uint8_t data_6[] = {0x00,0x24,0x33,0x90,0x7d,0xEA,0x64,0x32,0xC8,0x64,0xC8,0x32,0x90,0x90,0x11,0x06,0xDC,0xFA,0x14,0x03,0x80,0xFE,0x10,0x10,0x00,0x0A,0x0A,0x44,0x50};
	const uint8_t data_7[] = {0x18,0x00,0x00,0x03,0xFE,0x15,0x27,0x20,0x00,0x00,0x88,0xDE,0x0D,0x08,0x0F,0x0F,0x01,0x15,0x27,0x20,0x00,0x00,0x00};
	const uint8_t data_8[] = {0x05,0x0A,0x05,0x0A,0x00,0xE0,0x2E,0x0B,0x12,0x22,0x12,0x22,0x01,0x00,0x00,0x3F,0x6A,0x18,0xC8,0x22};
	const uint8_t data_9[] = {0x50,0x32,0x28,0x00,0xa0,0x80,0x8f,0x00,0x80,0xff,0x07,0x11,0x9F,0x6F,0xff,0x22,0x0c,0x0d,0x0e,0x0f};
	const uint8_t data_10[] = {0x33,0x44,0x44,0x01};
	const uint8_t data_11[] = {0x2C,0x1E,0x88,0x58,0x13,0x18,0x56,0x18,0x1E,0x68,0x75,0x00,0x6a,0x09,0x22,0xC4,0x0C,0x77,0x22,0x44,0xAA,0x55,0x04,0x04,0x12,0xA0,0x08};
	const uint8_t data_12[] = {0x20,0x70,0x89,0x0E,0x35,0x03,0x50,0x28,0x04,0x50,0x28,0x04,0x08,0x6A,0x00,0x46,0x45,0x45,0x45,0x45,0x88,0x01,0x03,0x00,0xE0,0x51,0x5C,0x3c,0x3c,0x00};
	const uint8_t data_13[] = {0x10,0x32,0x54,0x76,0x98,0xBA,0xDC,0xFE,0x13,0x04,0x01,0x01,0x35,0x35,0x00,0x35,0x35,0x00,0x03,0x03,0x03,0x03,0x3c,0x3c,0x00,0x83,0x00,0x23,0x01,0x00};
	const uint8_t data_14[] = {0x1F,0x02,0x00,0x0A,0x08,0x0E,0x0C,0x18,0x1F,0x19,0x18,0x1F,0x20,0x70,0x04,0x00,0x20,0xB0,0x1F};
	const uint8_t data_15[] = {0x1F,0x03,0x01,0x0B,0x09,0x0F,0x0D,0x18,0x1F,0x19,0x18,0x1F};
	const uint8_t data_16[] = {0x1F,0x01,0x03,0x0D,0x0F,0x09,0x0B,0x18,0x1F,0x19,0x1F,0x18};
	const uint8_t data_17[] = {0x1F,0x00,0x02,0x0C,0x0E,0x08,0x0A,0x18,0x1F,0x19,0x1F,0x18};
	const uint8_t data_18[] = {0x44,0x73,0x4B,0x69,0x00,0x0A,0x02,0x90};
	const uint8_t data_19[] = {0x22,0x00,0x00,0x10,0x0b,0x08,0x12,0x22,0x43,0x1c,0x0a,0x34,0x12,0x25,0x28,0x0f,0x00};
	const uint8_t data_20[] = {0x35,0x00,0x00,0x10,0x0b,0x08,0x13,0x22,0x43,0x1c,0x0a,0x34,0x12,0x25,0x28,0x0f,0x19};
	const uint8_t data_21[] = {0x25,0x0d,0x12,0x18,0x0E,0x0D,0x17,0x35,0x44,0x32,0x0C,0x14,0x14,0x36,0x3A,0x2F,0x0D};
	const uint8_t data_22[] = {0x37,0x07,0x12,0x18,0x0E,0x0D,0x17,0x35,0x44,0x32,0x0C,0x14,0x14,0x36,0x32,0x2F,0x0F};
	const uint8_t data_23[] = {0x3B,0x07,0x12,0x18,0x0E,0x0D,0x17,0x39,0x44,0x2E,0x0C,0x14,0x14,0x36,0x3A,0x2F,0x0D};
	const uint8_t data_24[] = {0x37,0x07,0x12,0x18,0x0E,0x0D,0x17,0x39,0x44,0x2E,0x0C,0x14,0x14,0x36,0x3A,0x2F,0x0F};
	const uint8_t data_25[] = {0x01,0x03,0x02,0x12,0x32,0x42,0x52,0x00,0x61,0x60,0x05,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00};	//video_mode
	const uint8_t data_26[] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00};

	_panel_transmit(dev, 0xBB, data_0, sizeof(data_0));
	_panel_transmit(dev, 0xA0, data_1, sizeof(data_1));
	_panel_transmit(dev, 0xA2, data_2, sizeof(data_2));
	_panel_transmit(dev, 0xD0, data_3, sizeof(data_3));
	_panel_transmit(dev, 0xA3, data_4, sizeof(data_4));
	_panel_transmit(dev, 0xC1, data_5, sizeof(data_5));
	_panel_transmit(dev, 0xC4, data_6, sizeof(data_6));
	_panel_transmit(dev, 0xC5, data_7, sizeof(data_7));
	_panel_transmit(dev, 0xC6, data_8, sizeof(data_8));
	_panel_transmit(dev, 0xC7, data_9, sizeof(data_9));
	_panel_transmit(dev, 0xC9, data_10, sizeof(data_10));
	_panel_transmit(dev, 0xCF, data_11, sizeof(data_11));
	_panel_transmit(dev, 0xD5, data_12, sizeof(data_12));
	_panel_transmit(dev, 0xD6, data_13, sizeof(data_13));
	_panel_transmit(dev, 0xD7, data_14, sizeof(data_14));
	_panel_transmit(dev, 0xD8, data_15, sizeof(data_15));
	_panel_transmit(dev, 0xD9, data_16, sizeof(data_16));
	_panel_transmit(dev, 0xDD, data_17, sizeof(data_17));
	_panel_transmit(dev, 0xDF, data_18, sizeof(data_18));
	_panel_transmit(dev, 0xE0, data_19, sizeof(data_19));
	_panel_transmit(dev, 0xE1, data_20, sizeof(data_20));
	_panel_transmit(dev, 0xE2, data_21, sizeof(data_21));
	_panel_transmit(dev, 0xE3, data_22, sizeof(data_22));
	_panel_transmit(dev, 0xE4, data_23, sizeof(data_23));
	_panel_transmit(dev, 0xE5, data_24, sizeof(data_24));
	_panel_transmit(dev, 0xF3, data_25, sizeof(data_25));
	_panel_transmit(dev, 0xBB, data_26, sizeof(data_26));
	_panel_transmit_cmd(dev, 0x11); /* Sleep Out */
	k_msleep(120);
	_panel_transmit_cmd(dev, 0x29); /* Display On */
	k_msleep(50);

	return 0;
}

static const struct lcd_panel_ops lcd_panel_ops = {
	.init = _panel_init,
};

__aligned(4) __in_section_unique(ram.noinit.lcd.fb)
static uint8_t lcd_framebuffer_mem[CONFIG_PANEL_HOR_RES * CONFIG_PANEL_VER_RES * CONFIG_PANEL_COLOR_DEPTH / 8];

const struct lcd_panel_config lcd_panel_axs15231b_config = {
	.videoport = PANEL_VIDEO_PORT_INITIALIZER,
	.videomode = PANEL_VIDEO_MODE_INITIALIZER,
	.ops = &lcd_panel_ops,
	.fb_mem = lcd_framebuffer_mem,
	.cmd_ramwr = DDIC_QSPI_CMD_RAMWR(DDIC_CMD_VS),
	.cmd_hsync = DDIC_QSPI_CMD_RAMWR(DDIC_CMD_HS),
	.tw_reset = 20,
	.ts_reset = 120,
};
