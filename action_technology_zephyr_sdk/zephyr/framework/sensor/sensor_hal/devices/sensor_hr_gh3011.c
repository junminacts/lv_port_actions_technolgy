/*******************************************************************************
 * @file    sensor_hr_gh3011.c
 * @author  MEMS Application Team
 * @version V1.0
 * @date    2022-08-03
 * @brief   sensor devices module
*******************************************************************************/

/******************************************************************************/
//includes
/******************************************************************************/
#include <sensor_hr_gh3011.h>

/******************************************************************************/
//constants
/******************************************************************************/

/******************************************************************************/
//sensor task
/******************************************************************************/
const i2c_task_t gh3011_task = {
	.irq_type = I2C_TASK_IRQ_CMPLT | I2C_TASK_IRQ_HALF_CMPLT,
#if defined(CONFIG_SOC_SERIES_LEOPARD)
	.ctl = {
		.sdataddr_sel = 0,
		.rdlen_wsdat = 16,
		.swen = 0,
	},
	.slavedev = {
		.rwsel = 1,
		.sdevaddr = GH3011_ADR,
		.sdataddr = 0xaa,
	},
#else
	.ctl = {
		.rwsel = 1,
		.sdevaddr = GH3011_ADR,
		.sdataddr = 0xaa,
		.rdlen_wsdat = 16,
	},
#endif
	.dma = {
		.reload = 1,
		.len = (2 * 16),
	},
	.trig = {
		.en = 0,
		.chan = 0,
		.task = 0,
		.trig = 0,
	},
};

/******************************************************************************/
//sensor config
/******************************************************************************/
const sensor_cfg_t gh3011_init_cfg[] = {
	{ 0xdddd,    1,  { 0xc0 } }, // write test cmd
	{ REG_DELAY, 1,  { 0 } }, // delay 1ms
	{ REG_NULL }, // end
};

/******************************************************************************/
// sensor function
/******************************************************************************/
int gh3011_cvt(float *val, uint8_t *buf, uint16_t len, int16_t *raw)
{
	int idx;
	
	if (val != NULL) {
		for (idx = 0; idx < 4; idx++) {
			val[idx] = (buf[3*idx+2] << 16) | (buf[3*idx+1] << 8) | buf[3*idx];
		}
	}
	
	return 4;
}
